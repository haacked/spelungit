#!/usr/bin/env bash
#/ Usage: bin/check [options]
#/ Description: Run all quality checks (formatting, linting, type checking, security)
#/ Options:
#/   --fix         Automatically fix issues where possible
#/   -v, --verbose Verbose output

source "$(dirname "$0")/helpers/_utils.sh"
set_source_and_root_dir

# Check if we need a virtual environment for Python tools
if ! command_exists python || ! command_exists pip; then
	error "Python and pip are required"
	exit 1
fi

# Check if in venv - if not, try to run with venv
if ! check_venv; then
	# Try to find a venv and re-run this script with it
	if venv_path=$(find_venv); then
		info "Found virtual environment at '$venv_path', re-running with it..."
		exec bin/with-venv "$0" "$@"
	else
		warning "Running outside virtual environment - some tools may not be available"
		info "For best results, run: source venv/bin/activate"
		echo ""
	fi
fi

fix_mode=false

while (("$#")); do
	case "$1" in
	--fix)
		fix_mode=true
		shift
		;;
	-v | --verbose)
		export VERBOSE=1
		shift
		;;
	-h | --help)
		show_help
		exit 0
		;;
	*)
		shift
		;;
	esac
done

print_color blue "Running all quality checks..."

success=true

# Format check/fix
if $fix_mode; then
	if ! run_command "bin/fmt" "Formatting code"; then
		success=false
	fi
else
	if ! run_command "bin/fmt --check" "Checking code formatting"; then
		success=false
	fi
fi

# Linting
lint_cmd="bin/lint"
if $fix_mode; then
	lint_cmd="$lint_cmd --fix"
fi
if ! run_command "$lint_cmd" "Running linters"; then
	success=false
fi

# Security checks - don't fail the build but report issues
if command_exists bandit; then
	print_color blue "Running security scan"
	# Skip common false positives for git operations
	if bandit -r src/ -s B404,B603,B607 >/dev/null 2>&1; then
		print_color green "✓ Running security scan"
	else
		print_color yellow "⚠ Running security scan found issues"
		echo "Security scan details (showing summary):"
		bandit -r src/ -s B404,B603,B607 --format json 2>/dev/null | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    results = data.get('results', [])
    if results:
        print(f'  Found {len(results)} security issues:')
        for result in results[:5]:  # Show first 5 issues
            print(f'    - {result[\"issue_text\"]} (Line {result[\"line_number\"]})')
        if len(results) > 5:
            print(f'    ... and {len(results) - 5} more issues')
    else:
        print('  All legitimate security issues resolved!')
except Exception as e:
    print(f'  Run: bandit -r src/ -s B404,B603,B607 for details')
"
		if [ $? -eq 0 ]; then
			info "Security scan clean after filtering false positives"
		else
			warning "Security issues found (legitimate concerns)"
		fi
	fi
else
	info "Bandit not available - skipping security scan"
fi

if command_exists safety; then
	print_color blue "Checking dependency vulnerabilities"
	if safety check --short-report >/dev/null 2>&1; then
		print_color green "✓ Checking dependency vulnerabilities"
	else
		print_color yellow "⚠ Checking dependency vulnerabilities found issues"
		echo "Vulnerability scan details:"
		safety check --short-report 2>&1 | grep -E "(vulnerability|Vulnerability|ADVISORY)" | head -10 | sed 's/^/  /'
		warning "Dependency vulnerabilities found (often low-risk issues)"
	fi
else
	info "Safety not available - skipping dependency vulnerability check"
fi

# Pre-commit hooks removed - now pre-commit calls this script instead
# This prevents circular dependency and tool conflicts

if $success; then
	print_color green "✓ All quality checks passed"
else
	print_color red "✗ Some quality checks failed"
	if ! $fix_mode; then
		print_color yellow "Try running: bin/check --fix"
	fi
	exit 1
fi
